<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Curator</title> 
    <style>
        /* Base Styling + News List Image */
        body { font-family: Arial, sans-serif; background-color: #000000; color: #f0f0f0; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: auto; position: relative; } /* Added position: relative */
        h1, h2, h3 { color: #ffffff; border-bottom: 2px solid #555; padding-bottom: 10px; text-align: center; margin-bottom: 15px; }
        h3 { border-bottom: none; font-size: 1.1em; }
        .article { background-color: #111111; padding: 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; border: 1px solid #333; display: flex; align-items: center; }
        .article-content { flex-grow: 1; }
        .article h2 { margin-top: 0; font-size: 1.2em; color: #ffffff; border-bottom: none; text-align: left; margin-bottom: 5px; }
        .article p { font-size: 0.8em; color: #ccc; margin-top: 0;}
        .article-image { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px; flex-shrink: 0; }

        /* --- NEW: Filter Menu Styles --- */
        #filter-menu-btn {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 100;
            background: #222;
            border: 1px solid #444;
            color: white;
            width: 44px;
            height: 44px;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            padding: 10px;
            box-sizing: border-box;
        }
        #filter-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: white;
            border-radius: 1px;
        }
        #filter-dropdown {
            display: none; /* Hidden by default */
            position: absolute;
            top: 50px;
            left: 0;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            z-index: 99;
            width: 320px; /* Increased width for longer text */
            padding: 10px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            max-height: 400px; /* Added max-height for scrolling */
            overflow-y: auto; /* Added overflow scrolling */
        }
        #filter-dropdown a {
            display: block;
            padding: 10px 20px;
            color: #e0e0e0;
            text-decoration: none;
            font-size: 0.9em; /* Slightly smaller font */
            white-space: nowrap; /* Prevent line breaks */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #filter-dropdown a:hover {
            background-color: #3a3a3a;
        }
        /* --- END: Filter Menu Styles --- */

        /* UI State & Image Grid + Context Links */
        .hidden { display: none; }
        .image-selection-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 10px; }
        .image-container { display: flex; flex-direction: column; align-items: center; }
        .image-container img { width: 100%; height: 120px; object-fit: cover; cursor: pointer; border: 3px solid transparent; border-radius: 4px; margin-bottom: 5px; }
        .image-container img:hover { border-color: #555; }
        .image-container a { display: block; text-decoration: none; color: #aaa; font-size: 0.7em; text-align: center; margin-top: 2px; word-break: break-all; }
        .image-keyword { display: block; color: #777; font-size: 0.6em; text-align: center; margin-top: 1px; font-style: italic; }
        .image-dimensions {
             display: block; color: #666; font-size: 0.6em; text-align: center;
             margin-top: 1px;
        }
        #image-loader-sentinel { height: 50px; text-align: center; color: #888; }


        /* AI Text Preview Styling + Original Link */
        #ai-text-preview { padding: 15px; background-color: #1a1a1a; margin-bottom: 10px; border-radius: 4px; border: 1px solid #333; }
        #preview-headline { margin-top: 0; color: #FF6B6B; font-size: 1.4em; border-bottom: none; text-align: left;}
        #preview-description { font-size: 0.9em; color: #eee; margin-bottom: 10px;}
        #preview-caption-text { margin-top: 10px; font-style: italic; font-size: 0.9em; border-top: 1px dashed #333; padding-top: 10px; white-space: pre-wrap; /* Ensure line breaks show */ }
        #original-article-link-container { margin-bottom: 20px; text-align: center; font-size: 0.9em;}
        #original-article-link-container a { color: #87CEFA; text-decoration: none; }
        #original-article-link-container a:hover { text-decoration: underline; }


        #original-image-container img { width: 100%; max-width: 400px; margin: 10px auto; display: block; border: 2px solid #444; cursor: pointer; }
        #related-articles-list { display: flex; flex-direction: column; gap: 8px; }
        .related-article { background-color: #222; padding: 10px; border-radius: 4px; }
        .related-article a { color: #87CEFA; text-decoration: none; font-size: 0.9em; }
        .related-article p { font-size: 0.8em; color: #999; margin: 5px 0 0 0; }
        #video-display-area { margin-top: 20px; margin-bottom: 20px; }
        #video-display-area iframe,
        #video-display-area video { width: 100%; max-width: 560px; aspect-ratio: 16 / 9; display: block; margin: 0 auto; border: 1px solid #333; border-radius: 4px; }
        
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; margin-top: 5px; }
        button:hover { background-color: #0056b3; }
        button#download-preview-btn { background-color: #17a2b8; margin-right: 10px; }
        button.back-button { background-color: #6c757d; margin-left: 10px;}
        button#share-preview-btn { background-color: #007bff; margin-right: 10px;}
        button#share-link-btn { background-color: #28a745; margin-right: 10px; }
        button#share-link-btn:hover { background-color: #218838; }
        button#copy-caption-btn { background-color: #6f42c1; }
        button#copy-caption-btn:hover { background-color: #5a2e9b; }
        #simple-preview-image { width: 100%; max-width: 600px; margin: auto; display: block; margin-bottom: 20px; }
        #ai-caption-display { background-color: #1a1a1a; padding: 15px; margin-top: 20px; border-radius: 4px; border: 1px solid #333; }
        #ai-caption-display h3 { margin-top: 0; color: #FF6B6B; font-size: 1.4em; border-bottom: none; text-align: left;}
        #ai-caption-display #caption-text-area { width: 100%; height: 120px; background-color: #222; color: #f0f0f0; border: 1px solid #444; padding: 10px; box-sizing: border-box; resize: vertical; font-family: Arial, sans-serif; font-size: 0.9em; margin-bottom: 10px; white-space: pre-wrap; /* Ensure line breaks show */}
        #simple-preview-video-player { width: 100%; max-width: 600px; aspect-ratio: 16 / 9; margin: auto; display: none; margin-bottom: 20px; border: 1px solid #444;}
    
        /* --- NEW LINK MANAGEMENT STYLES --- */
        #view-toggle-container {
            text-align: right;
            margin-bottom: 15px;
            /* Add margin to not overlap with filter button */
            margin-left: 60px;
        }
        #view-toggle-btn {
            background-color: #343a40;
            border-color: #343a40;
        }
        .add-link-form {
            background-color: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .add-link-form input[type="text"] {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #222;
            color: #f0f0f0;
            font-size: 1em;
        }
        #add-link-btn {
            background-color: #28a745;
        }
        #current-links-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .link-manage-item {
            background-color: #222;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #444;
        }
        .link-manage-item p {
            margin: 0;
            font-size: 1.1em;
            word-break: break-all;
        }
        .delete-link-btn {
            background-color: #dc3545;
            padding: 8px 12px;
            font-size: 0.9em;
            flex-shrink: 0;
            margin-left: 15px;
        }
        .delete-link-btn:hover {
            background-color: #c82333;
        }
        /* --- END OF STYLES --- */
    </style>
</head>
<body>
    <div class="container">

        <button id="filter-menu-btn">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div id="filter-dropdown">
            <a href="#" class="filter-option" data-category="all">All Topics</a>
            <a href="#" class="filter-option" data-category="üì∞ Top-Level World & US News">üì∞ Top-Level World & US News</a>
            <a href="#" class="filter-option" data-category="üåç International & Regional News">üåç International & Regional News</a>
            <a href="#" class="filter-option" data-category="üèõÔ∏è Politics & Policy">üèõÔ∏è Politics & Policy</a>
            <a href="#" class="filter-option" data-category="üíº Business & Finance">üíº Business & Finance</a>
            <a href="#" class="filter-option" data-category="üíª Technology (General)">üíª Technology (General)</a>
            <a href="#" class="filter-option" data-category="ü§ñ AI & Cybersecurity">ü§ñ AI & Cybersecurity</a>
            <a href="#" class="filter-option" data-category="üî¨ Science & Space">üî¨ Science & Space</a>
            <a href="#" class="filter-option" data-category="ü©∫ Health & Medicine">ü©∫ Health & Medicine</a>
            <a href="#" class="filter-option" data-category="üåø Environment & Climate">üåø Environment & Climate</a>
            <a href="#" class="filter-option" data-category="ü§î Culture, Opinion & Long-form">ü§î Culture, Opinion & Long-form</a>
            <a href="#" class="filter-option" data-category="üé¨ Entertainment & Fandom">üé¨ Entertainment & Fandom</a>
            <a href="#" class="filter-option" data-category="üé® Creative: Art & Photography">üé® Creative: Art & Photography</a>
            <a href="#" class="filter-option" data-category="üè† Creative: Design & Architecture">üè† Creative: Design & Architecture</a>
            <a href="#" class="filter-option" data-category="üëü Creative: Fashion & Style">üëü Creative: Fashion & Style</a>
            <a href="#" class="filter-option" data-category="üçî Hobbies: Food & Cooking">üçî Hobbies: Food & Cooking</a>
            <a href="#" class="filter-option" data-category="üéÆ Hobbies: Video Games">üéÆ Hobbies: Video Games</a>
            <a href="#" class="filter-option" data-category="‚öΩ Hobbies: Sports">‚öΩ Hobbies: Sports</a>
            <a href="#" class="filter-option" data-category="üöó Hobbies: Automotive">üöó Hobbies: Automotive</a>
            <a href="#" class="filter-option" data-category="üìö Intellectual: History, Philosophy, Literature">üìö Intellectual: History, Philosophy, Literature</a>
            <a href="#" class="filter-option" data-category="üí° Lifestyle & Productivity">üí° Lifestyle & Productivity</a>
            <a href="#" class="filter-option" data-category="üïµÔ∏è Investigative & Fact-Checking">üïµÔ∏è Investigative & Fact-Checking</a>
            <a href="#" class="filter-option" data-category="üéôÔ∏è Popular Podcasts (as Feeds)">üéôÔ∏è Popular Podcasts (as Feeds)</a>
        </div>
        <div id="view-toggle-container">
            <button id="view-toggle-btn">Manage Links</button>
        </div>

        <div id="news-feed-view">
            <h1>NEWS FEED CURATOR</h1> 
            <p>Tap a headline to create the social media post.</p>
            <div id="news-list"> Loading news... </div>
        </div>

        <div id="selection-view" class="hidden">
             <h2>Select Your Post Visual</h2>
             <div id="ai-text-preview">
                 <h3 id="preview-headline">AI Caption Generated Below</h3>
                 <p id="preview-description"></p>
                 <p id="preview-caption-text"></p>
             </div>
             <div id="original-article-link-container">
                 <a id="original-article-link" href="#" target="_blank" rel="noopener noreferrer">View Original Article</a>
             </div>
             <div id="original-image-container" class="hidden">
                 <h3>Original Article Image:</h3>
                 <img id="original-image" src="" alt="Original Article Image" />
             </div>
             <h3>Relevant Web Images:</h3>
             <div id="image-selection-area" class="image-selection-grid">
                 <p>Generating AI text to determine search query...</p>
             </div>
             <div id="image-loader-sentinel" style="height: 50px;"></div>
             <h3>Other Sources:</h3>
             <div id="related-articles-list">
                 <p>Finding related articles...</p>
             </div>
        </div>

        <div id="simple-preview-view" class="hidden">
            <h2>Quick Preview</h2>
            <img id="simple-preview-image" src="" alt="Simple Preview" />
            <div id="simple-preview-video-player" style="display: none;"></div>
            <div id="video-display-area" class="hidden">
                <h3>Related Video:</h3>
                <div id="video-player-container"></div>
            </div>
            <div id="ai-caption-display">
                <h3>AI Caption:</h3>
                <textarea id="caption-text-area" readonly></textarea>
                <button id="copy-caption-btn">Copy Caption</button>
            </div>
            <button id="share-preview-btn">Share Post</button>
            <button id="share-link-btn">Share Post & Link in Bio</button>
            <button id="download-preview-btn">Download Image</button>
            <button onclick="setView('select')" class="back-button">Back to Selection</button>
        </div>
        
        <div id="link-management-view" class="hidden">
            <h2>Link Management</h2>
            <p>Add or remove links shown on your public homepage.</p>
            
            <div class="add-link-form">
                <h3>Add New Link</h3>
                <input type="text" id="new-link-title" placeholder="Display Title">
                <input type="text" id="new-link-url" placeholder="Full URL (e.g., https://...)">
                <button id="add-link-btn">Add New Link</button>
            </div>

            <h3>Current Links</h3>
            <div id="current-links-list">
                <p>Loading current links...</p>
            </div>
        </div>

    </div>

<script>
        // --- Global State Variables ---
        let currentArticleData = null;
        let currentCuratedData = null;
        let simplePreviewImagePath = null; 
        let currentObjectUrl = null; 
        let currentVideoUrl = null;
        const IMAGES_PER_PAGE = 9;
        let currentSearchKeywords = [];
        let currentKeywordIndex = 0;
        let currentImageStartIndex = 0;
        let currentImageContextUrl = null;
        let isFetchingImages = false; 
        let imageObserver = null; 

        // --- Event Listener for DOM Load ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed. Calling fetchNews()...");
            fetchNews(); // Load news feed on start
            initializeInfiniteScroll(); 

            // Preview buttons
            document.getElementById('download-preview-btn').onclick = () => handleDownload();
            document.getElementById('share-preview-btn').onclick = () => handleShare();
            document.getElementById('copy-caption-btn').onclick = () => handleCopyCaption();
            document.getElementById('share-link-btn').onclick = () => handleShareAndLink();
            
            // --- NEW: Link management listeners ---
            document.getElementById('view-toggle-btn').onclick = () => toggleView();
            document.getElementById('add-link-btn').onclick = () => handleAddManualLink();
            // Use event delegation for delete buttons
            document.getElementById('current-links-list').addEventListener('click', (event) => {
                if (event.target && event.target.classList.contains('delete-link-btn')) {
                    const linkId = event.target.dataset.id;
                    handleDeleteLink(linkId);
                }
            });

            // --- NEW: Filter Menu Listeners ---
            const filterBtn = document.getElementById('filter-menu-btn');
            const filterDropdown = document.getElementById('filter-dropdown');
            
            filterBtn.onclick = (e) => {
                e.stopPropagation(); // Prevent body click
                const isHidden = filterDropdown.style.display === 'none' || filterDropdown.style.display === '';
                filterDropdown.style.display = isHidden ? 'block' : 'none';
            };

            // Add listener to all filter options
            document.querySelectorAll('.filter-option').forEach(item => {
                item.onclick = (e) => {
                    e.preventDefault();
                    const category = e.target.dataset.category;
                    filterNews(category);
                    filterDropdown.style.display = 'none'; // Hide dropdown after click
                };
            });

            // Hide dropdown if clicking anywhere else
            document.body.onclick = (e) => {
                if (e.target.id !== 'filter-menu-btn' && !e.target.closest('#filter-menu-btn')) {
                    filterDropdown.style.display = 'none';
                }
            };
        });

        // --- Infinite Scroll Setup ---
        function initializeInfiniteScroll() {
            // ... (This function is unchanged) ...
            const sentinel = document.getElementById('image-loader-sentinel');
            if (!sentinel) return;
            const options = { root: null, rootMargin: '0px', threshold: 0.1 };
            imageObserver = new IntersectionObserver((entries) => {
                const entry = entries[0];
                if (entry.isIntersecting && !isFetchingImages) {
                    console.log("[Observer] Sentinel visible, loading more images...");
                    loadMoreImages();
                }
            }, options);
            imageObserver.observe(sentinel);
        }

        // --- Logic for loading more images ---
        function loadMoreImages() {
            // ... (This function is unchanged) ...
            if (isFetchingImages || currentSearchKeywords.length === 0) return;
            isFetchingImages = true;
            currentImageStartIndex += IMAGES_PER_PAGE;
            const currentKeyword = currentSearchKeywords[currentKeywordIndex];
            console.log(`[loadMoreImages] Loading next images for "${currentKeyword}", starting at index ${currentImageStartIndex}`);
            fetchImages(currentKeyword, currentImageStartIndex);
        }

        // --- UI View Handler (UPDATED) ---
        function setView(viewId) {
            // --- Hides all main views ---
            document.getElementById('news-feed-view').classList.add('hidden');
            document.getElementById('selection-view').classList.add('hidden');
            document.getElementById('simple-preview-view').classList.add('hidden');
            document.getElementById('link-management-view').classList.add('hidden');

            const toggleBtn = document.getElementById('view-toggle-btn');
            const filterBtn = document.getElementById('filter-menu-btn'); // Get filter button
            
            if (viewId === 'list') { 
                document.getElementById('news-feed-view').classList.remove('hidden');
                toggleBtn.textContent = "Manage Links";
                filterBtn.style.display = 'flex'; // Show filter button
                console.log("setView: Showing 'news-feed-view'.");
            }
            else if (viewId === 'select') { 
                document.getElementById('selection-view').classList.remove('hidden');
                console.log("setView: Showing 'selection-view'.");
                toggleBtn.textContent = "News Feed"; // Button text to go back
                filterBtn.style.display = 'none'; // Hide filter button
            }
            else if (viewId === 'simple-preview') {
                document.getElementById('simple-preview-view').classList.remove('hidden');
                console.log("setView: Showing 'simple-preview-view'.");
                populateCaptionDisplay();
                filterBtn.style.display = 'none'; // Hide filter button
                // ... (rest of the logic is unchanged) ...
                const downloadBtn = document.getElementById('download-preview-btn');
                const imgPreview = document.getElementById('simple-preview-image');
                const videoPreview = document.getElementById('simple-preview-video-player');
                if (currentVideoUrl) { 
                    imgPreview.style.display = 'none'; 
                    videoPreview.style.display = 'block'; 
                    document.getElementById('video-display-area').classList.remove('hidden');
                    downloadBtn.textContent = 'Download/Open Video'; 
                } else { 
                    imgPreview.style.display = 'block'; 
                    videoPreview.style.display = 'none'; 
                    document.getElementById('video-display-area').classList.add('hidden');
                    downloadBtn.textContent = 'Download Image'; 
                }
            }
            // --- NEW: Link management view ---
            else if (viewId === 'link-management') {
                document.getElementById('link-management-view').classList.remove('hidden');
                toggleBtn.textContent = "Back to News Feed";
                filterBtn.style.display = 'none'; // Hide filter button
                console.log("setView: Showing 'link-management-view'.");
                fetchAndRenderLinks(); // Load the links when switching to this view
            }
        }

        // --- NEW: View Toggle Function ---
        function toggleView() {
            const linkView = document.getElementById('link-management-view');
            const selectionView = document.getElementById('selection-view');
            
            if (linkView.classList.contains('hidden') && selectionView.classList.contains('hidden')) {
                // We are on the news feed, switch to link management
                setView('link-management');
            } else {
                // We are on link management OR selection view, switch to news feed
                setView('list');
            }
        }
        
        // --- NEW: Fetch and Render Links for Management ---
        async function fetchAndRenderLinks() {
            const listElement = document.getElementById('current-links-list');
            listElement.innerHTML = '<p>Loading current links...</p>';
            try {
                const response = await fetch('/api/links/get');
                if (!response.ok) throw new Error('Failed to fetch links.');
                
                const links = await response.json();
                
                if (!links || links.length === 0) {
                    listElement.innerHTML = '<p>No links have been added yet.</p>';
                    return;
                }

                listElement.innerHTML = ''; // Clear list
                links.forEach(link => {
                    const item = document.createElement('div');
                    item.className = 'link-manage-item';
                    item.innerHTML = `
                        <p>${link.title}</p>
                        <button class="delete-link-btn" data-id="${link._id}">Delete</button>
                    `;
                    listElement.appendChild(item);
                });
            } catch (error) {
                console.error("Error fetching links:", error);
                listElement.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        // --- NEW: Handle Manual Link Add ---
        async function handleAddManualLink() {
            const titleInput = document.getElementById('new-link-title');
            const urlInput = document.getElementById('new-link-url');
            
            const title = titleInput.value.trim();
            const link = urlInput.value.trim();

            if (!title || !link) {
                alert("Please enter both a Title and a URL.");
                return;
            }

            try {
                const response = await fetch('/api/links/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, link })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to add link.');
                }
                
                alert("Link added successfully!");
                titleInput.value = '';
                urlInput.value = '';
                fetchAndRenderLinks(); // Refresh the list
            } catch (error) {
                console.error("Error adding link:", error);
                alert(`Error: ${error.message}`);
            }
        }

        // --- NEW: Handle Link Deletion ---
        async function handleDeleteLink(linkId) {
            if (!confirm("Are you sure you want to delete this link?")) {
                return;
            }
            
            try {
                const response = await fetch(`/api/links/delete/${linkId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to delete link.');
                }

                alert("Link deleted successfully.");
                fetchAndRenderLinks(); // Refresh the list
            } catch (error) {
                console.error("Error deleting link:", error);
                alert(`Error: ${error.message}`);
            }
        }


        // --- NEW: Filter News Function ---
        function filterNews(category) {
            console.log(`Filtering by category: ${category}`);
            const allArticles = document.querySelectorAll('#news-list .article');
            let visibleCount = 0;

            allArticles.forEach(article => {
                if (category === 'all' || article.dataset.category === category) {
                    article.style.display = 'flex';
                    visibleCount++;
                } else {
                    article.style.display = 'none';
                }
            });

            if (visibleCount === 0 && category !== 'all') {
                // Optionally show a message if no articles match
                // For now, it just shows a blank list
            }
        }


        // --- Fetch Initial News Feed (UPDATED) ---
        async function fetchNews() {
            console.log("fetchNews function STARTED.");
            const newsListElement = document.getElementById('news-list');
            if (!newsListElement) { console.error("CRITICAL ERROR: news-list element NOT FOUND!"); alert("Page structure error."); return; }
            newsListElement.innerHTML = 'Loading news...';
            try {
                console.log("Inside try block, BEFORE fetch('/api/news')");
                const response = await fetch('/api/news');
                console.log("AFTER fetch('/api/news'), Status:", response.status);
                if (!response.ok) { console.error("Fetch response NOT ok:", response.status); throw new Error(`HTTP error! status: ${response.status}`); }
                console.log("Response OK. Trying response.json()...");
                const articles = await response.json();
                console.log("Successfully parsed JSON. Number of articles:", articles ? articles.length : 'null/undefined');
                if (!articles || articles.length === 0) { newsListElement.innerHTML = '<p>No news articles found.</p>'; console.log("No articles found."); return; }
                newsListElement.innerHTML = '';
                console.log("Cleared loading message. Starting article loop...");
                articles.forEach((article, index) => {
                    const articleElement = document.createElement('div'); 
                    articleElement.className = 'article'; 
                    articleElement.dataset.link = article.link;
                    
                    // --- *** THIS IS THE FIX *** ---
                    // Default old/uncategorized articles to the first category
                    articleElement.dataset.category = article.category || 'üì∞ Top-Level World & US News';
                    // --- *** END FIX *** ---

                    const imgElement = document.createElement('img'); imgElement.className = 'article-image';
                    imgElement.src = article.originalImageUrl || '/fallback-thumbnail.png'; 
                    imgElement.alt = 'Article thumbnail'; 
                    imgElement.onerror = function() { this.src='/fallback-thumbnail.png'; };
                    const contentElement = document.createElement('div'); contentElement.className = 'article-content'; 
                    contentElement.innerHTML = `<h2>${article.title}</h2><p>Source: ${article.source} | Published: ${new Date(article.pubDate).toLocaleDateString()}</p>`;
                    articleElement.appendChild(imgElement); articleElement.appendChild(contentElement);
                    articleElement.onclick = () => handleArticleTap(article);
                    newsListElement.appendChild(articleElement);
                });
                console.log("Finished processing all articles.");
            } catch (error) { console.error('!!! CATCH ERROR inside fetchNews:', error); newsListElement.innerHTML = '<p style="color: red;">Failed to load news. Check console.</p>'; }
        }

        // --- Handle Article Selection ---
        async function handleArticleTap(article) {
            // ... (This function is unchanged) ...
            console.log("handleArticleTap called for:", article.title);
            if (currentObjectUrl) {
                URL.revokeObjectURL(currentObjectUrl);
                currentObjectUrl = null;
            }
            currentArticleData = article; currentCuratedData = null; currentVideoUrl = null; simplePreviewImagePath = null;
            currentSearchKeywords = []; currentKeywordIndex = 0; currentImageStartIndex = 0; currentImageContextUrl = null;
            isFetchingImages = false; 
            document.getElementById('image-loader-sentinel').innerHTML = ''; 
            setView('select');
            document.getElementById('preview-headline').innerText = "AI Caption Generated Below";
            document.getElementById('preview-description').innerText = "";
            document.getElementById('preview-caption-text').innerText = "Generating AI text...";
            document.getElementById('image-selection-area').innerHTML = "<p>Generating AI text to determine search query...</p>"; document.getElementById('related-articles-list').innerHTML = "<p>Finding related articles...</p>";
            document.getElementById('video-player-container').innerHTML = ''; 
            document.getElementById('video-display-area').classList.add('hidden'); 
            document.getElementById('original-image-container').classList.add('hidden');
            const originalLinkEl = document.getElementById('original-article-link'); originalLinkEl.href = article.link; originalLinkEl.textContent = `View Original Article on ${article.source}`;
            fetchAiText(article);
            fetchRelatedArticles(article.title, article.source);
            fetchVideo(article.title, article.source, article.videoUrl);
            if (article.originalImageUrl) { const originalImgEl = document.getElementById('original-image'); const originalImgContainer = document.getElementById('original-image-container'); originalImgEl.src = article.originalImageUrl; originalImgEl.onclick = () => startSimplePreviewPipeline(article.originalImageUrl, article.link); originalImgContainer.classList.remove('hidden'); }
        }

        // --- Fetch AI Text & Trigger Keyword Extraction ---
        async function fetchAiText(article) {
            // ... (This function is unchanged) ...
            console.log("fetchAiText function STARTED.");
            const previewHeadlineEl=document.getElementById('preview-headline'); const previewDescriptionEl=document.getElementById('preview-description'); const previewCaptionEl=document.getElementById('preview-caption-text'); const imageSelectionArea=document.getElementById('image-selection-area');
            if(!previewHeadlineEl||!previewDescriptionEl||!previewCaptionEl||!imageSelectionArea){console.error("fetchAiText Error: Preview elements not found!");return;}
            previewHeadlineEl.innerText = "AI Caption Generated Below";
            previewDescriptionEl.innerText = "";
            previewCaptionEl.innerText = "Generating AI text...";
            imageSelectionArea.innerHTML="<p>Generating AI text to determine search query...</p>";
            console.log("fetchAiText: Set initial 'Generating AI text...' messages.");
            try{
                console.log("fetchAiText: Sending request to /api/generate-text for:",article.title);
                const response=await fetch('/api/generate-text',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(article)});
                console.log("fetchAiText: AFTER fetch('/api/generate-text'), Status:",response.status);
                if(!response.ok){const errorText=await response.text();console.error("fetchAiText: Fetch response NOT ok:",response.status,errorText);throw new Error(`HTTP error! ${response.status} - ${errorText}`);}
                console.log("fetchAiText: Response OK. Parsing JSON...");
                currentCuratedData=await response.json(); 
                console.log("fetchAiText: Successfully parsed AI text response:",currentCuratedData);
                previewHeadlineEl.innerText = currentCuratedData.headline || "AI Failed headline."; 
                previewDescriptionEl.innerText = currentCuratedData.description || "No description."; 
                previewCaptionEl.innerText = (currentCuratedData.caption || "No caption.") + `\n\nNews Source: ${currentCuratedData.originalSource||'Unknown'}`; 
                console.log("fetchAiText: Populated AI text to UI.");
                if(currentCuratedData.headline && currentCuratedData.headline !== "AI Failed"){
                    console.log("fetchAiText: Calling fetchPrimaryKeywords...");
                    fetchPrimaryKeywordsAndStartImageSearch(currentCuratedData.headline, currentCuratedData.description);
                } else{
                    imageSelectionArea.innerHTML="<p>AI text failed, cannot search images.</p>";
                    console.warn("fetchAiText: AI failed.");
                }
            }catch(error){console.error('!!! CATCH ERROR inside fetchAiText:',error);previewHeadlineEl.innerText="Error Generating AI Text";previewDescriptionEl.innerText="Please try another article or check server logs.";previewCaptionEl.innerText="";imageSelectionArea.innerHTML="<p>Error generating AI text.</p>";}
        }

        // --- Fetch Primary Keywords & Start Image Search ---
        async function fetchPrimaryKeywordsAndStartImageSearch(headline, description) {
            // ... (This function is unchanged) ...
            document.getElementById('image-selection-area').innerHTML = '<p>Extracting primary keywords...</p>';
            try {
                console.log("fetchPrimaryKeywords: Sending request to /api/extract-keywords");
                const response = await fetch('/api/extract-keywords', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ headline, description }) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                let primaryKeyword = data.keywords;
                if (!primaryKeyword) { 
                    console.warn("[Keywords] Primary extraction failed, falling back to article title."); 
                    primaryKeyword = currentArticleData.title; 
                }
                console.log(`[Keywords] Received primary: "${primaryKeyword}", starting image search.`);
                currentSearchKeywords = [primaryKeyword]; 
                currentKeywordIndex = 0; 
                currentImageStartIndex = 0;
                fetchImages(primaryKeyword, 0); 
            } catch (error) { 
                console.error("Error fetching primary keywords:", error); 
                console.warn("[Keywords] Fetch failed, falling back to article title."); 
                let fallbackKeyword = currentArticleData.title; 
                currentSearchKeywords = [fallbackKeyword]; 
                currentKeywordIndex = 0; 
                currentImageStartIndex = 0; 
                document.getElementById('image-selection-area').innerHTML = `<p>Keyword fetch failed, using title: "${fallbackKeyword}"</p>`; 
                fetchImages(fallbackKeyword, 0); 
            }
        }

        // --- Fetch Alternative Keywords ---
        async function fetchAlternativeKeywords() {
            // ... (This function is unchanged) ...
            isFetchingImages = true; 
            const loader = document.getElementById('image-loader-sentinel');
            if (!currentCuratedData) { alert("Cannot get alternative keywords."); isFetchingImages = false; return; }
            loader.innerHTML = '<p>Searching for alternative keywords...</p>';
            try {
                console.log("fetchAlternativeKeywords: Sending request to /api/get-alternative-keywords");
                const response = await fetch('/api/get-alternative-keywords', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ headline: currentCuratedData.headline, description: currentCuratedData.description, previousKeywords: currentSearchKeywords }) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.keywords) { 
                    const newKeyword = data.keywords; 
                    console.log(`[AltKeywords] Received alternative: "${newKeyword}"`); 
                    currentSearchKeywords.push(newKeyword); 
                    currentKeywordIndex++; 
                    currentImageStartIndex = 0; 
                    fetchImages(newKeyword, 0); 
                }
                else { 
                    console.warn("[AltKeywords] No suitable alternative found."); 
                    loader.innerHTML = '<p>No alternative keywords found. No more images to load.</p>';
                    isFetchingImages = true; 
                }
            } catch (error) { 
                console.error("Error fetching alternative keywords:", error); 
                loader.innerHTML = '<p>Failed to get alternative keywords.</p>';
                isFetchingImages = true; 
            }
        }

	    // --- Fetch Images ---
        async function fetchImages(query, startIndex) {
            // ... (This function is unchanged) ...
            isFetchingImages = true; 
            const area = document.getElementById('image-selection-area');
            const loader = document.getElementById('image-loader-sentinel');
            if (startIndex === 0) {
                area.innerHTML = `<p>Searching images: "${query}"...</p>`;
            } else {
                loader.innerHTML = '<p>Loading more images...</p>';
            }
            try {
                console.log(`fetchImages: Sending request for "${query}", start index ${startIndex}`);
                const response = await fetch('/api/search-images', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: query, startIndex: startIndex }) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const imagesData = data.images || [];
                console.log(`fetchImages: Received ${imagesData.length} images.`);
                if (startIndex === 0) area.innerHTML = ''; 
                loader.innerHTML = ''; 
                if (imagesData.length === 0) {
                    if (startIndex === 0) {
                        area.innerHTML = `<p>No images found for "${query}".</p>`;
                    }
                    loader.innerHTML = '<p>No more images for this keyword. Fetching alternatives...</p>';
                    fetchAlternativeKeywords(); 
                }
                else {
                    imagesData.forEach((imgData, index) => {
                         const container = document.createElement('div'); container.className = 'image-container';
                         const img = document.createElement('img'); img.src = imgData.imageUrl; img.alt = `Relevant Image ${startIndex + index + 1}`; img.onerror = function() { this.alt = 'Image failed'; this.style.border = '1px solid red'; };
                         const imageUrlForClick = imgData.imageUrl; const contextUrlForClick = imgData.contextUrl;
                         img.onclick = () => { console.log(`Image clicked! URL: ${imageUrlForClick}, Context: ${contextUrlForClick}`); startSimplePreviewPipeline(imageUrlForClick, contextUrlForClick); };
                         const link = document.createElement('a'); link.href = imgData.contextUrl || '#'; link.textContent = 'View Source Page'; link.target = '_blank'; link.rel = 'noopener noreferrer'; if (!imgData.contextUrl) link.style.display = 'none';
                         const keywordSpan = document.createElement('span'); keywordSpan.className = 'image-keyword'; keywordSpan.textContent = `Keyword: ${imgData.query || 'N/A'}`;
                         const dimensionsSpan = document.createElement('span'); dimensionsSpan.className = 'image-dimensions'; dimensionsSpan.textContent = (imgData.width && imgData.height) ? `${imgData.width} x ${imgData.height}` : `Dimensions N/A`;
                         container.appendChild(img); container.appendChild(link); container.appendChild(keywordSpan); container.appendChild(dimensionsSpan);
                         area.appendChild(container);
                     });
                    console.log("fetchImages: Finished rendering images.");
                    isFetchingImages = false; 
                 }
            } catch (error) { 
                console.error('Error fetching images:', error); 
                if (startIndex === 0) area.innerHTML = `<p>Image search failed for "${query}".</p>`;
                loader.innerHTML = '<p>Image search failed.</p>';
                isFetchingImages = false; 
            }
        }

        // --- Fetch Related Articles ---
        async function fetchRelatedArticles(title, source) {
            // ... (This function is unchanged) ...
            const list = document.getElementById('related-articles-list');
            if (!list) { console.error("fetchRelatedArticles Error: List element not found!"); return; }
            list.innerHTML = "<p>Finding related articles...</p>";
            console.log(`fetchRelatedArticles: Searching for articles related to "${title}" from "${source}"`);
            try {
                const response = await fetch('/api/find-related-articles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: title, source: source })
                });
                console.log(`fetchRelatedArticles: Response Status: ${response.status}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                console.log("fetchRelatedArticles: Received data:", data);
                const relatedArticles = data.relatedArticles || [];
                list.innerHTML = '';
                if (relatedArticles.length === 0) {
                    list.innerHTML = "<p>No other sources found.</p>";
                    console.log("fetchRelatedArticles: No related articles found in response.");
                    return;
                }
                console.log(`fetchRelatedArticles: Rendering ${relatedArticles.length} articles.`);
                relatedArticles.forEach(article => {
                    if (currentArticleData && article.link === currentArticleData.link) return;
                    const el = document.createElement('div');
                    el.className = 'related-article';
                    el.innerHTML = `<a href="${article.link}" target="_blank" rel="noopener noreferrer">${article.title}</a><p>${article.source}</p>`;
                    list.appendChild(el);
                });
                console.log("fetchRelatedArticles: Finished rendering.");
            } catch (error) {
                console.error('!!! CATCH ERROR fetching related articles:', error);
                list.innerHTML = "<p style='color: red;'>Related article search failed.</p>";
            }
        }

        // --- Fetch Video ---
        async function fetchVideo(title, source, rssVideoUrl) {
            // ... (This function is unchanged) ...
            let videoUrlToDisplay = rssVideoUrl;
            if (!videoUrlToDisplay) {
                console.log("[Video] No video in RSS, searching online...");
                try {
                    const response = await fetch('/api/find-video', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: title, source: source })
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    videoUrlToDisplay = data.videoUrl;
                    console.log("[Video] Online search result:", videoUrlToDisplay);
                } catch (error) { console.error('Error fetching related video:', error); videoUrlToDisplay = null; }
            } else { console.log("[Video] Using video URL from RSS:", videoUrlToDisplay); }
            if (videoUrlToDisplay) {
                currentVideoUrl = videoUrlToDisplay;
                displayVideo(videoUrlToDisplay, 'video-player-container');
            } else {
                console.log("[Video] No video found from RSS or search.");
                currentVideoUrl = null; 
            }
        }

        // --- Display Video ---
        function displayVideo(videoUrl, containerId) {
            // ... (This function is unchanged) ...
             let videoElement = null;
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            const youtubeMatch = videoUrl.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i);
            if (youtubeMatch && youtubeMatch[1]) {
                 const videoId = youtubeMatch[1];
                 console.log(`[Video] Embedding YouTube video (${containerId}):`, videoId);
                 videoElement = document.createElement('iframe');
                 videoElement.src = `https://www.youtube.com/embed/${videoId}`;
                 videoElement.frameborder = "0";
                 videoElement.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
                 videoElement.allowfullscreen = true;
            } else if (videoUrl.match(/\.(mp4|webm|ogg)$/i)) {
                  console.log(`[Video] Embedding direct video link (${containerId}):`, videoUrl);
                  videoElement = document.createElement('video');
                  videoElement.src = videoUrl;
                  videoElement.controls = true;
                  videoElement.preload = "metadata";
             } else {
                  console.warn(`[Video] Cannot embed unknown video URL type (${containerId}):`, videoUrl);
                  container.innerHTML = `<p>Video found: <a href="${videoUrl}" target="_blank" rel="noopener noreferrer">${videoUrl}</a> (Cannot embed player)</p>`;
              }
            if (videoElement) { container.appendChild(videoElement); }
             if (containerId === 'video-player-container') {
                const simplePreview = document.getElementById('simple-preview-view');
                if(!simplePreview.classList.contains('hidden')) { 
                    document.getElementById('video-display-area').classList.remove('hidden');
                }
            }
        }

        // --- Call Simple Preview API ---
        async function startSimplePreviewPipeline(mediaUrl, contextUrl = null) {
            // ... (This function is unchanged) ...
             console.log(`startSimplePreviewPipeline called with URL: ${mediaUrl}, Context: ${contextUrl}`);
             const isVideo = currentVideoUrl && mediaUrl === currentVideoUrl; const isImageUrl = !isVideo;
             console.log(`startSimplePreviewPipeline: Is Video? ${isVideo}, Is Image? ${isImageUrl}`);
             currentVideoUrl = isVideo ? mediaUrl : null; 
             simplePreviewImagePath = null; 
             currentImageContextUrl = isImageUrl ? contextUrl : null;
             if (currentObjectUrl) {
                URL.revokeObjectURL(currentObjectUrl);
                currentObjectUrl = null;
            }
             try {
                  if (isImageUrl) {
                      if (!currentCuratedData || !currentCuratedData.caption) { 
                           alert("AI caption data is not ready. Cannot generate preview.");
                           return;
                       }
                      alert("Generating preview image...");
                      console.log("startSimplePreviewPipeline: Proceeding with image generation.");
                      const socialCaption = currentCuratedData.caption;
                      const socialHeadline = socialCaption.split('\n\n')[0].trim(); 
                      console.log(`startSimplePreviewPipeline: Extracted social headline: "${socialHeadline}"`);
                      console.log("startSimplePreviewPipeline: Sending request to /api/generate-simple-preview");
                      const response = await fetch('/api/generate-simple-preview', { 
                          method: 'POST', 
                          headers: { 'Content-Type': 'application/json' }, 
                          body: JSON.stringify({ 
                              imageUrl: mediaUrl, 
                              overlayText: socialHeadline
                            }) 
                        });
                      console.log(`startSimplePreviewPipeline: Received response. Status: ${response.status}`);
                      if (!response.ok) { 
                          const errorData = await response.json();
                          console.error(`startSimplePreviewPipeline: Error response: ${response.status}`, errorData.error); 
                          throw new Error(`Server error: ${errorData.error || response.status}`); 
                      }
                      const contentType = response.headers.get("content-type");
                      if (contentType && contentType.includes("image/png")) {
                           console.log("startSimplePreviewPipeline: Received image/png blob.");
                           const imageBlob = await response.blob();
                           simplePreviewImagePath = URL.createObjectURL(imageBlob); 
                           currentObjectUrl = simplePreviewImagePath; 
                           console.log(`startSimplePreviewPipeline: Object URL created: ${simplePreviewImagePath}`);
                      } else {
                           console.error('startSimplePreviewPipeline: Invalid data received (not an image).');
                           throw new Error('Preview generation failed or invalid response type.');
                      }
                  }
                  else if (isVideo) {
                      alert("Preparing video preview...");
                      console.log("startSimplePreviewPipeline: Setting up video preview.");
                      displayVideo(currentVideoUrl, 'simple-preview-video-player'); 
                  }
                  if (simplePreviewImagePath || currentVideoUrl) {
                      console.log("startSimplePreviewPipeline: Setting view to 'simple-preview'.");
                      setView('simple-preview'); 
                      if (simplePreviewImagePath) {
                           document.getElementById('simple-preview-image').src = simplePreviewImagePath;
                      }
                  }
                  else { console.warn("startSimplePreviewPipeline: No image/video path set."); alert('Preview generation failed.'); }
             } catch (error) { console.error('!!! CATCH ERROR in simple preview pipeline:', error); alert(`Failed to create preview: ${error.message}.`); simplePreviewImagePath = null; currentVideoUrl = null; }
        }

        // --- Populate Caption Display ---
        function populateCaptionDisplay() {
            // ... (This function is unchanged) ...
             console.log("populateCaptionDisplay: Function called.");
             const captionTextArea = document.getElementById('caption-text-area');
             if (!captionTextArea) { console.error("populateCaptionDisplay Error: Text area element not found!"); return; }
             if (currentCuratedData && currentCuratedData.caption && currentCuratedData.headline !== "AI Failed") {
                 const caption = currentCuratedData.caption;
                 let visualSourceLine = "";
                 if (currentImageContextUrl) {
                     try { const urlObject = new URL(currentImageContextUrl); const domain = urlObject.hostname.replace(/^www\./, ''); visualSourceLine = `Visual Source: ${domain}`; } catch (e) { console.warn("Could not parse context URL:", currentImageContextUrl); visualSourceLine = `Visual Source: (See source page)`; }
                 } else if (currentVideoUrl) {
                     try { const urlObject = new URL(currentVideoUrl); const domain = urlObject.hostname.replace(/^www\./, ''); visualSourceLine = `Visual Source: ${domain}`; } catch (e) { console.warn("Could not parse video URL:", currentVideoUrl); visualSourceLine = `Visual Source: (See video source)`; }
                 }
                 const bioLinkText = "For more info, link is in the bio...";
                 const fullText = caption + 
                                  (visualSourceLine ? `\n\n${visualSourceLine}` : '') +
                                  `\n\n${bioLinkText}`; 
                 captionTextArea.value = fullText;
             } else {
                 captionTextArea.value = "AI Caption data is not available or generation failed.";
             }
        }
        // --- Handle Copy Caption ---
        async function handleCopyCaption() {
            // ... (This function is unchanged) ...
            const captionTextArea = document.getElementById('caption-text-area'); try { await navigator.clipboard.writeText(captionTextArea.value); alert("Caption copied!"); } catch (err) { console.error('Failed to copy:', err); alert("Failed to copy."); captionTextArea.select(); }
        }
        
        // --- Publish Link to Bio ---
        async function publishLinkToBio() {
            // ... (This function is unchanged) ...
            if (!currentArticleData || !currentCuratedData) {
                alert("Article data is not ready.");
                throw new Error("Article data not ready.");
            }
            const linkTitle = (currentCuratedData.headline || "New Article").replace(/^\*\*|\*\*$/g, '');
            const linkUrl = currentArticleData.link;
            console.log(`Publishing to bio: "${linkTitle}" -> ${linkUrl}`);
            const response = await fetch('/api/links/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: linkTitle,
                    link: linkUrl
                })
            });
            if (!response.ok) {
                let errorMsg = "Failed to add link to bio.";
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.error || errorMsg;
                } catch (e) {}
                throw new Error(errorMsg);
            }
            const result = await response.json();
            console.log("Link published successfully:", result.message);
        }
        
        // --- Share and Link ---
        async function handleShareAndLink() {
            // ... (This function is unchanged) ...
            try {
                await publishLinkToBio();
                handleShare();
            } catch (error) {
                console.error("Failed to publish link:", error);
                alert(`Error publishing link: ${error.message}. Sharing was cancelled.`);
            }
        }
        
        // --- Share Button Logic ---
        async function handleShare() {
            // ... (This function is unchanged) ...
            if (!simplePreviewImagePath && !currentVideoUrl) { alert("No image/video generated."); return; } if (!currentCuratedData) { alert("AI caption not ready."); return; } const shareTitle = (currentCuratedData.headline || "News Post").replace(/^\*\*|\*\*$/g, ''); const shareText = document.getElementById('caption-text-area').value; let shareData = { title: shareTitle, text: shareText, };
            if (navigator.share) { 
                try { 
                    if (simplePreviewImagePath && navigator.canShare) { 
                        const imageUrl = simplePreviewImagePath; 
                        console.log(`Fetching image for sharing: ${imageUrl}`); 
                        const response = await fetch(imageUrl); 
                        if (!response.ok) throw new Error(`Failed to fetch image: ${response.statusText}`); 
                        const blob = await response.blob(); 
                        const fileName = `${shareTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`; 
                        const file = new File([blob], fileName, { type: 'image/png' }); 
                        if (navigator.canShare({ files: [file] })) { 
                            shareData.files = [file]; 
                            console.log("Sharing image file/text..."); 
                        } else { 
                            console.warn("Cannot share image file, sharing text/URL."); 
                            shareData.url = imageUrl; 
                        } 
                    } else if (currentVideoUrl) { 
                        console.log("Sharing text/video URL..."); 
                        shareData.url = currentVideoUrl; 
                    } else { 
                        console.log("Sharing text only..."); 
                    } 
                    await navigator.share(shareData); 
                    console.log('Successful share via Web Share API'); 
                } catch (err) { 
                    console.error('Error during Web Share API:', err); 
                    if (err.name === 'AbortError') { 
                        console.log('Share cancelled.'); 
                    } else { 
                        alert(`Sharing failed: ${err.message}. Caption copied.`); 
                        handleCopyCaption(); 
                    } 
                } 
            }
            else { console.log("Web Share API not supported."); alert("Native sharing not supported. Caption copied."); handleCopyCaption(); }
        }
        
        // --- Download Button Logic ---
        function handleDownload() {
            // ... (This function is unchanged) ...
            let didDownload = false; 
            if (currentVideoUrl) { 
                alert("Opening video URL..."); 
                window.open(currentVideoUrl, '_blank'); 
                didDownload = true; 
            } else if (simplePreviewImagePath) { 
                if (!currentCuratedData) { alert("AI data needed for filename."); return; } 
                const link = document.createElement('a'); 
                link.href = simplePreviewImagePath; 
                const cleanedHeadlineText = (currentCuratedData?.headline || 'news-post').replace(/^\*\*|\*\*$/g, '').replace(/[^a-z0-9]/gi, '_').toLowerCase(); 
                link.download = `${cleanedHeadlineText}.png`; 
                document.body.appendChild(link); 
                link.click(); 
                document.body.removeChild(link); 
                didDownload = true; 
            } else { 
                alert("No image/video available."); 
            }
        }

    </script>
</body>
</html>
